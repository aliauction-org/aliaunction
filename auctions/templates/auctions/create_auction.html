{% extends "base.html" %}
{% load static %}

{% block content %}
<div style="max-width:800px;margin:2rem auto;padding:0 1rem;">

  <h1 style="margin-bottom: 2rem;">Create New Auction</h1>

  {% if messages %}
  {% for message in messages %}
  <div
    style="padding: 1rem; margin-bottom: 1rem; background: {% if message.tags == 'error' %}#fef2f2{% else %}#f0fdf4{% endif %}; color: {% if message.tags == 'error' %}#dc2626{% else %}#15803d{% endif %}; border-radius: 8px;">
    {{ message }}</div>
  {% endfor %}
  {% endif %}

  <form method="post" enctype="multipart/form-data" id="auctionForm">
    {% csrf_token %}

    <!-- Title -->
    <div style="margin-bottom:1.5rem;">
      <label for="id_title" style="display: block; margin-bottom: 0.5rem; font-weight: 600;">
        Title <span style="color:red">*</span>
      </label>
      <input type="text" name="title" id="id_title" required
        style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem;"
        value="{{ form.title.value|default:'' }}">
      {% if form.title.errors %}
      <div style="color:red; margin-top: 0.25rem;">{{ form.title.errors.0 }}</div>
      {% endif %}
    </div>

    <!-- Description -->
    <div style="margin-bottom:1.5rem;">
      <label for="id_description" style="display: block; margin-bottom: 0.5rem; font-weight: 600;">
        Description <span style="color:red">*</span>
      </label>
      <textarea name="description" id="id_description" rows="5" required
        style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem; resize: vertical;">{{ form.description.value|default:'' }}</textarea>
      {% if form.description.errors %}
      <div style="color:red; margin-top: 0.25rem;">{{ form.description.errors.0 }}</div>
      {% endif %}
    </div>

    <!-- Starting Price -->
    <div style="margin-bottom:1.5rem;">
      <label for="id_starting_price" style="display: block; margin-bottom: 0.5rem; font-weight: 600;">
        Starting Price <span style="color:red">*</span>
      </label>
      <div style="position:relative;">
        <span
          style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color: var(--text-secondary);">‚Çπ</span>
        <input type="number" name="starting_price" id="id_starting_price" step="0.01" min="0" required
          style="width: 100%; padding: 0.75rem 0.75rem 0.75rem 2rem; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem;"
          value="{{ form.starting_price.value|default:'' }}">
      </div>
      {% if form.starting_price.errors %}
      <div style="color:red; margin-top: 0.25rem;">{{ form.starting_price.errors.0 }}</div>
      {% endif %}
    </div>

    <!-- End Time -->
    <div style="margin-bottom:1.5rem;">
      <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">
        End Date & Time <span style="color:red">*</span>
      </label>

      <div style="display:flex; gap:0.5rem; flex-wrap:wrap; align-items: center;">
        <input type="number" min="1" max="31" required placeholder="DD" id="day" ...>
          style="width:60px; padding:0.75rem; text-align:center; border: 1px solid var(--border-color); border-radius: 8px;">
        <span style="color: var(--text-secondary);">/</span>
        <input type="number" min="1" max="12" required placeholder="MM" id="Month" ...>
          style="width:60px; padding:0.75rem; text-align:center; border: 1px solid var(--border-color); border-radius: 8px;">
        <span style="color: var(--text-secondary);">/</span>
        <input type="number" maxlength="4" placeholder="YYYY" id="year"
          style="width:80px; padding:0.75rem; text-align:center; border: 1px solid var(--border-color); border-radius: 8px;">
        <span style="margin-left:0.5rem;">‚è∞</span>
        <input type="number" maxlength="2" placeholder="HH" id="hour"
          style="width:60px; padding:0.75rem; text-align:center; border: 1px solid var(--border-color); border-radius: 8px;">
        <span style="color: var(--text-secondary);">:</span>
        <input type="number" maxlength="2" placeholder="MM" id="minute"
          style="width:60px; padding:0.75rem; text-align:center; border: 1px solid var(--border-color); border-radius: 8px;">
      </div>

      <small style="color:var(--text-secondary); display: block; margin-top: 0.5rem;">
        Format: Day / Month / Year - Hour:Minute (24-hour format)
      </small>

      <!-- Hidden field for Django -->
      <input type="hidden" name="end_time" id="id_end_time">

      {% if form.end_time.errors %}
      <div style="color:red; margin-top: 0.25rem;">{{ form.end_time.errors.0 }}</div>
      {% endif %}
    </div>

    <!-- Image Upload -->
    <div style="margin-bottom:1.5rem;">
      <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">
        Product Image
      </label>

      <div id="imageUploadArea" style="
        border: 2px dashed var(--border-color);
        border-radius: 12px;
        padding: 2rem;
        text-align: center;
        background: var(--bg-secondary);
        cursor: pointer;
        transition: all 0.2s ease;
      " onclick="document.getElementById('id_image').click();">
        <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">üì∑</div>
        <div style="font-weight: 600; margin-bottom: 0.25rem;" id="imageFileName">
          Click to upload product image
        </div>
        <div style="font-size: 0.85rem; color: var(--text-secondary);">
          JPG, PNG or WEBP - max 5MB
        </div>
        <input type="file" name="image" id="id_image" accept="image/*" style="display:none;"
          onchange="updateImageName(this)">
      </div>

      {% if form.image.errors %}
      <div style="color:red; margin-top: 0.25rem;">{{ form.image.errors.0 }}</div>
      {% endif %}
    </div>

    <!-- Submit Buttons -->
    <div style="margin-top:2rem; display:flex; gap:1rem;">
      <button type="submit" style="
        flex: 1;
        padding: 1rem 1.5rem;
        background: linear-gradient(135deg, #2563eb, #1d4ed8);
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
      ">
        üöÄ Create Auction
      </button>

      <a href="{% url 'dashboard_home' %}" style="
        padding: 1rem 1.5rem;
        border: 1px solid var(--border-color);
        border-radius: 10px;
        font-size: 1rem;
        text-decoration: none;
        color: var(--text-main);
        display: flex;
        align-items: center;
        justify-content: center;
      ">
        Cancel
      </a>
    </div>

  </form>
</div>

<script>
  // Auto-jump between date/time fields
  const fields = ['day', 'month', 'year', 'hour', 'minute'];

  fields.forEach((fieldId, index) => {
    const field = document.getElementById(fieldId);
    field.addEventListener('input', function () {
      // Only allow numbers
      this.value = this.value.replace(/[^0-9]/g, '');

      // Auto-jump to next field
      if (this.value.length === this.maxLength && index < fields.length - 1) {
        document.getElementById(fields[index + 1]).focus();
      }

      // Update hidden datetime field
      updateHiddenDateTime();
    });
  });

  function updateHiddenDateTime() {
    const dayRaw = document.getElementById('day').value;
    const monthRaw = document.getElementById('month').value;
    const yearRaw = document.getElementById('year').value;
    const hourRaw = document.getElementById('hour').value;
    const minuteRaw = document.getElementById('minute').value;

    // Only build the hidden field when ALL inputs exist and have expected lengths
    if (!dayRaw || !monthRaw || !yearRaw || !hourRaw || !minuteRaw) {
      document.getElementById('id_end_time').value = "";
      return;
    }
    if (yearRaw.length !== 4) {
      document.getElementById('id_end_time').value = "";
      return;
    }

    const d = String(dayRaw).padStart(2, '0');
    const m = String(monthRaw).padStart(2, '0');
    const h = String(hourRaw).padStart(2, '0');
    const min = String(minuteRaw).padStart(2, '0');

    document.getElementById('id_end_time').value = ${yearRaw}-${m}-${d}T${h}:${min};
  }

  // ALSO update on blur/change for mobile keyboards
  ['day','month','year','hour','minute'].forEach(id => {
    const el = document.getElementById(id);
    el.addEventListener('blur', updateHiddenDateTime);
    el.addEventListener('change', updateHiddenDateTime);
  });

  document.getElementById('auctionForm').addEventListener('submit', function (e) {
    updateHiddenDateTime();
    const endTime = document.getElementById('id_end_time').value;
    if (!endTime) {
      e.preventDefault();
      alert('Please fill in the complete end date and time.');
    }

  function updateImageName(input) {
    const fileName = input.files[0] ? input.files[0].name : 'Click to upload product image';
    document.getElementById('imageFileName').textContent = fileName;
    if (input.files[0]) {
      document.getElementById('imageUploadArea').style.borderColor = '#10b981';
      document.getElementById('imageUploadArea').style.background = '#f0fdf4';
    }
  }

  // Form validation before submit
  document.getElementById('auctionForm').addEventListener('submit', function (e) {
    const endTime = document.getElementById('id_end_time').value;
    if (!endTime) {
      e.preventDefault();
      alert('Please fill in the complete end date and time.');
      document.getElementById('day').focus();
      return false;
    }
  });
</script>

{% endblock %}
