{% extends 'base.html' %}
{% load indian_format %}
{% load static %}

{% block content %}
<div class="container" style="padding: 2rem 0;">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
    <div>
      <h1 style="font-size: 2rem; color: var(--text-main); margin-bottom: 0.5rem;">All Auctions</h1>
      <p style="color: var(--text-secondary);">Browse our collection of premium items</p>
    </div>

    {% if user.is_authenticated %}
    <a href="{% url 'create_auction' %}" class="btn btn-primary">
      <span style="font-weight: bold; margin-right: 0.5rem;">+</span> Create Auction
    </a>
    {% endif %}
  </div>

  <!-- Search & Filters -->
  <div class="card" style="margin-bottom: 2rem; padding: 1.5rem;">
    <form method="get" action="" id="filter-form">
      <!-- Search Bar -->
      <div style="display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap;">
        <div style="flex: 2; min-width: 250px;">
          <input type="text" name="q" placeholder="Search auctions..." value="{{ search_query }}"
            style="width: 100%; padding: 0.75rem 1rem; border: 1px solid var(--border-color); border-radius: var(--radius-md);">
        </div>
        <div style="flex: 1; min-width: 150px;">
          <select name="category"
            style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: var(--radius-md); background: white;">
            <option value="">All Categories</option>
            {% for cat in categories %}
            <option value="{{ cat.slug }}" {% if selected_category==cat.slug %}selected{% endif %}>{{ cat.name }}
            </option>
            {% endfor %}
          </select>
        </div>
        <button type="submit" class="btn btn-primary">Search</button>
      </div>

      <!-- Advanced Filters Row -->
      <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
        <!-- Price Range -->
        <div style="display: flex; align-items: center; gap: 0.5rem;">
          <span style="color: var(--text-secondary); font-size: 0.9rem;">Price:</span>
          <input type="number" name="min_price" placeholder="Min" value="{{ min_price }}"
            style="width: 80px; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: var(--radius-md);">
          <span style="color: var(--text-muted);">-</span>
          <input type="number" name="max_price" placeholder="Max" value="{{ max_price }}"
            style="width: 80px; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: var(--radius-md);">
        </div>

        <div style="height: 25px; width: 1px; background: var(--border-color);"></div>

        <!-- Quick Filters -->
        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-size: 0.9rem;">
          <input type="checkbox" name="ending_soon" value="1" {% if ending_soon %}checked{% endif %}>
          <span>Ending Soon (24h)</span>
        </label>

        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-size: 0.9rem;">
          <input type="checkbox" name="new" value="1" {% if new_auctions %}checked{% endif %}>
          <span>New (7 days)</span>
        </label>

        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-size: 0.9rem;">
          <input type="checkbox" name="live_only" value="1" {% if live_only %}checked{% endif %}>
          <span>Live Only</span>
        </label>

        <div style="flex: 1;"></div>

        <!-- Sort -->
        <div style="display: flex; align-items: center; gap: 0.5rem;">
          <span style="color: var(--text-secondary); font-size: 0.9rem;">Sort:</span>
          <select name="sort" onchange="document.getElementById('filter-form').submit()"
            style="padding: 0.5rem; border: 1px solid var(--border-color); border-radius: var(--radius-md); background: white;">
            <option value="-created_at" {% if sort_by=='-created_at' %}selected{% endif %}>Newest First</option>
            <option value="created_at" {% if sort_by=='created_at' %}selected{% endif %}>Oldest First</option>
            <option value="-current_price" {% if sort_by=='-current_price' %}selected{% endif %}>Highest Price</option>
            <option value="current_price" {% if sort_by=='current_price' %}selected{% endif %}>Lowest Price</option>
            <option value="end_time" {% if sort_by=='end_time' %}selected{% endif %}>Ending Soonest</option>
          </select>
        </div>

        {% if search_query or selected_category or min_price or max_price or ending_soon or new_auctions or live_only %}
        <a href="{% url 'auction_list' %}" style="color: var(--text-secondary); font-size: 0.9rem;">Clear Filters</a>
        {% endif %}
      </div>
    </form>
  </div>

  {% if auctions %}
  <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 2rem;">
    {% for auction in auctions %}
    <div class="card">
      <a href="{% url 'auction_detail' auction.id %}" style="text-decoration: none; color: inherit; display: block;">
        <!-- Image Aspect Ratio Wrapper -->
        <div style="aspect-ratio: 4/3; overflow: hidden; background-color: #f1f5f9; position: relative;">
          {% if auction.image %}
          <img src="{{ auction.image.url }}" alt="{{ auction.title }}"
            style="width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s ease;">
          {% else %}
          <div
            style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-muted);">
            No Image
          </div>
          {% endif %}

          {% if auction.category %}
          <div
            style="position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.6); color: white; padding: 4px 8px; font-size: 0.75rem; border-radius: 4px; backdrop-filter: blur(4px);">
            {{ auction.category.name }}
          </div>
          {% endif %}

          {% if auction.is_featured %}
          <div
            style="position: absolute; top: 10px; right: 10px; background: var(--accent-color); color: white; padding: 4px 8px; font-size: 0.75rem; font-weight: 600; border-radius: 4px;">
            FEATURED
          </div>
          {% endif %}
        </div>

        <div class="card-body">
          <h3 style="font-size: 1.1rem; margin-bottom: 0.5rem; line-height: 1.4; min-height: 3em;">
            {{ auction.title|truncatechars:50 }}
          </h3>

          <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-top: 1rem;">
            <div>
              <div style="font-size: 0.85rem; color: var(--text-secondary);">Current Bid</div>
              <div style="font-size: 1.25rem; font-weight: 700; color: var(--text-main);">
                â‚¹{{ auction.current_price|indian_format }}
              </div>
            </div>

            <div style="text-align: right;">
              <div style="font-size: 0.85rem; color: var(--text-secondary);">Ends In</div>
              <div style="font-size: 0.95rem; font-weight: 500; font-variant-numeric: tabular-nums;">
                {% if auction.end_time|date:'U' < now|date:'U' %} <span style="color: var(--danger-color);">Ended</span>
                  {% else %}
                  {{ auction.end_time|timeuntil }}
                  {% endif %}
              </div>
            </div>
          </div>

          {% if user == auction.seller or user.is_staff %}
          <div
            style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
            <span style="font-size: 0.8rem; color: var(--text-muted);">Status: {{ auction.workflow.status }}</span>

            {% if auction.workflow.status == "DRAFT" %}
            <form method="post" action="{% url 'submit_auction' auction.id %}">
              {% csrf_token %}
              <button type="submit" class="btn btn-primary btn-sm"
                style="font-size: 0.8rem; padding: 0.25rem 0.75rem;">Submit</button>
            </form>
            {% endif %}
          </div>
          {% endif %}
        </div>
      </a>
    </div>
    {% endfor %}
  </div>
  {% else %}
  <div
    style="text-align: center; padding: 5rem 1rem; background: white; border-radius: var(--radius-lg); border: 1px solid var(--border-color);">
    <div style="font-size: 3rem; margin-bottom: 1rem;">ðŸ“­</div>
    <h3 style="font-size: 1.5rem; color: var(--text-main); margin-bottom: 0.5rem;">No active auctions</h3>
    <p style="color: var(--text-secondary); margin-bottom: 2rem;">Check back later or start your own auction.</p>
    {% if user.is_authenticated %}
    <a href="{% url 'create_auction' %}" class="btn btn-primary">Create Auction</a>
    {% endif %}
  </div>
  {% endif %}
</div>
{% endblock %}